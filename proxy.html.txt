<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å“¡å·¥è«‹å‡ä»£ç†äººæŸ¥æ‰¾ç³»çµ±</title>
    <!-- è¼‰å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ä½¿ç”¨ Inter å­—é«”ä»¥ç¢ºä¿ç¾ä»£æ„Ÿå’Œè·¨å¹³å°ä¸€è‡´æ€§ */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
    </style>
</head>
<body class="min-h-screen p-4 sm:p-6 md:p-10 bg-gray-50">

    <div class="max-w-2xl mx-auto bg-white shadow-xl rounded-2xl overflow-hidden">
        
        <!-- æ¨™é¡Œå€ -->
        <header class="bg-indigo-600 p-6 text-white">
            <h1 class="text-2xl font-bold">ä»£ç†äººæ‰‹å‹•é¸æ“‡ç³»çµ±</h1>
            <p class="text-indigo-200 text-sm mt-1">è«‹è¼¸å…¥è«‹å‡è³‡è¨Šï¼Œä¸¦å¾å€™é¸åå–®ä¸­é¸æ“‡ä»£ç†äººã€‚</p>
        </header>

        <!-- è¡¨å–®å€ -->
        <main class="p-6 space-y-6">
            
            <!-- æŸ¥è©¢çµæœé¡¯ç¤ºå€ -->
            <div id="result-box" class="min-h-[100px] p-4 border rounded-lg bg-yellow-50 border-yellow-300 text-gray-700">
                <p class="font-semibold text-yellow-700">ğŸ” è«‹å¡«å¯«ä¸Šæ–¹æ¬„ä½å¾Œï¼Œé»æ“Šã€ŒæŸ¥æ‰¾ä»£ç†äººã€æŒ‰éˆ•ã€‚</p>
            </div>

            <form id="proxy-form" class="space-y-4">
                
                <!-- å“¡å·¥ID (è«‹å‡äºº) -->
                <div>
                    <label for="employeeId" class="block text-sm font-medium text-gray-700 mb-1">
                        è«‹å‡å“¡å·¥å§“å (ID)
                    </label>
                    <select id="employeeId" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150" required>
                        <option value="" disabled selected>è«‹é¸æ“‡è«‹å‡å“¡å·¥...</option>
                    </select>
                </div>

                <!-- å‡åˆ¥é¸é … -->
                <div>
                    <label for="leaveType" class="block text-sm font-medium text-gray-700 mb-1">
                        å‡åˆ¥é¸æ“‡
                    </label>
                    <select id="leaveType" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150" required>
                        <option value="" disabled selected>è«‹é¸æ“‡å‡åˆ¥...</option>
                    </select>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <!-- é–‹å§‹æ—¥æœŸ -->
                    <div>
                        <label for="startDate" class="block text-sm font-medium text-gray-700 mb-1">
                            é–‹å§‹æ—¥æœŸ
                        </label>
                        <input type="date" id="startDate" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150" required>
                    </div>

                    <!-- çµæŸæ—¥æœŸ -->
                    <div>
                        <label for="endDate" class="block text-sm font-medium text-gray-700 mb-1">
                            çµæŸæ—¥æœŸ
                        </label>
                        <input type="date" id="endDate" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150" required>
                    </div>
                </div>

                <!-- æŸ¥è©¢æŒ‰éˆ• (è§¸ç™¼å€™é¸åå–®ç”Ÿæˆ) -->
                <button type="button" id="searchButton" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-4 rounded-lg shadow-md transition duration-200 transform hover:scale-[1.01] focus:outline-none focus:ring-4 focus:ring-indigo-300">
                    æŸ¥æ‰¾ä»£ç†äºº
                </button>
            </form>
            
            <!-- ä»£ç†äººé¸æ“‡å€ (ç¬¬äºŒéšæ®µï¼Œåˆå§‹éš±è—) -->
            <div id="selection-area" class="hidden space-y-4 pt-4 border-t border-gray-100">
                <div>
                    <label for="substituteSelect" class="block text-sm font-medium text-gray-700 mb-1 font-bold">
                        ç¬¬äºŒæ­¥ï¼šå¾å¯ç”¨åå–®ä¸­é¸æ“‡æœ€çµ‚ä»£ç†äºº
                    </label>
                    <select id="substituteSelect" class="w-full p-3 border border-indigo-500 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150" required>
                        <option value="" disabled selected>è«‹é¸æ“‡ä¸€ä½ä»£ç†äºº...</option>
                    </select>
                </div>
                <!-- ç¢ºèªæŒ‰éˆ• (è§¸ç™¼æœ€çµ‚çµæœé¡¯ç¤º) -->
                <button type="button" id="confirmButton" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-4 rounded-lg shadow-md transition duration-200 transform hover:scale-[1.01] focus:outline-none focus:ring-4 focus:ring-green-300">
                    ç¢ºèªé¸æ“‡é€™ä½ä»£ç†äºº
                </button>
            </div>

            <!-- ä¼‘å‡äººå“¡èˆ‡ä»£ç†äººè³‡è¨Šå€ (æ›´æ–°) -->
            <div id="active-leaves-area" class="mt-6 pt-4 border-t border-gray-100">
                <h3 class="text-lg font-bold text-gray-800 mb-2">ğŸ“… ç•¶å‰ä¼‘å‡äººå“¡èˆ‡ä»£ç†äººè·è²¬</h3>
                <ul id="active-leaves-list" class="space-y-2 text-sm">
                    <!-- åˆ—è¡¨æœƒåœ¨é€™è£¡å‹•æ…‹ç”Ÿæˆ -->
                    <li class="text-gray-500">æ­£åœ¨è¼‰å…¥è«‹å‡è³‡è¨Š...</li>
                </ul>
            </div>
            
            <!-- æ•¸æ“šå‚™è¨»å€ -->
            <div class="pt-4 border-t border-gray-100 mt-6">
                <p class="text-xs text-gray-400">
                    **ç°¡åŒ–è¦å‰‡ï¼š** å·²ç§»é™¤éƒ¨é–€/è·å‹™é™åˆ¶ã€‚ç‰¹æ¬Šä»£ç†äººå„ªå…ˆæ’åºã€‚
                </p>
                <p class="text-xs text-gray-400">
                    **è¡çªæª¢æŸ¥ï¼š** åªæœ‰ç•¶ä»£ç†äººä¸åœ¨è«‹æ±‚çš„æ—¥æœŸç¯„åœå…§ä¼‘å‡æ™‚ï¼Œæ‰æœƒå‡ºç¾åœ¨åå–®ä¸­ã€‚
                </p>
                <p class="text-xs text-red-500 mt-1">
                    è¨»ï¼šæ—¥æœŸæ ¼å¼è«‹ä½¿ç”¨ YYYY-MM-DDã€‚
                </p>
                <p class="text-xs text-red-500 mt-1">
                    **è«‹æ³¨æ„ï¼š** å–æ¶ˆè«‹å‡åŠŸèƒ½ç›®å‰æ˜¯ç§»é™¤æœ¬æ©Ÿç¡¬ç·¨ç¢¼çš„è³‡æ–™ã€‚åœ¨çœŸå¯¦ç³»çµ±ä¸­ï¼Œé€™æœƒéœ€è¦æ›´æ–°å¾Œç«¯è³‡æ–™åº«ã€‚
                </p>
            </div>
        </main>
    </div>

    <script>
        // --- æ ¸å¿ƒè³‡æ–™å®šç¾© (Data Definition) ---
        const LEAVE_TYPES = [
            "ä¼‘å‡ (Annual Leave)",
            "ç—…å‡ (Sick Leave)",
            "äº‹å‡ (Personal Leave)",
            "å–ªå‡ (Bereavement Leave)",
            "èº«å¿ƒèª¿é©å‡ (Mental Health Leave)"
        ];

        const SPECIAL_AGENT_A_ID = "E001"; // è¨±æ˜ç¥¥
        const SPECIAL_AGENT_B_ID = "E003"; // å‘‚ä¿¡å¿ 

        const employeeData = [
            {"id": "E001", "name": "è¨±æ˜ç¥¥"}, 
            {"id": "E002", "name": "ç‹å­æº"},
            {"id": "E003", "name": "å‘‚ä¿¡å¿ "},
            {"id": "E004", "name": "å³æ¬£å³°"},
            {"id": "E005", "name": "è¨±æ™¯ç¿”"},
            {"id": "E006", "name": "åŠ‰è¨“å®"},
            {"id": "E007", "name": "è¨±é‡‹æ™Ÿ"},
            {"id": "E008", "name": "è¨±å®—æ–‡"},
            {"id": "E009", "name": "åŠ‰æŸæ¦•"},
            {"id": "E010", "name": "æ¥Šç„œæ·µ"},
            {"id": "E011", "name": "è¬å‚‘å„’"},
            {"id": "E012", "name": "è˜‡ä¿Šç‘‹"},
        ];

        // æ´»èºè«‹å‡è¨˜éŒ„ (æ¨¡æ“¬è³‡æ–™åº«ä¸­å·²æœ‰çš„ä¼‘å‡å®‰æ’)
        // æ ¹æ“šä½¿ç”¨è€…è¦æ±‚ï¼Œé€™è£¡å°‡åˆå§‹åˆ—è¡¨æ¸…ç©º
        const activeLeaves = []; 

        // --- æ ¸å¿ƒé‚è¼¯å‡½æ•¸ (Core Logic Functions) ---

        /**
         * æª¢æŸ¥æ½›åœ¨ä»£ç†äººæ˜¯å¦åœ¨è«‹æ±‚çš„æ—¥æœŸç¯„åœå…§å·²å®‰æ’ä¼‘å‡ (ç¢ºä¿ä»£ç†äººç•¶å¤©å¯ç”¨)ã€‚
         */
        function isAvailable(employeeId, startDateStr, endDateStr, leaves) {
            // è½‰æ›æ—¥æœŸå­—ä¸²ç‚ºæ¯«ç§’æ•¸ï¼Œä»¥ä¾¿æ¯”è¼ƒ
            const reqStart = Date.parse(startDateStr);
            const reqEnd = Date.parse(endDateStr);

            // è™•ç†ç„¡æ•ˆæ—¥æœŸæˆ–æ—¥æœŸé †åºéŒ¯èª¤çš„æƒ…æ³
            if (isNaN(reqStart) || isNaN(reqEnd) || reqStart > reqEnd) {
                return true; 
            }

            for (const leave of leaves) {
                if (leave.id === employeeId) {
                    const leaveStart = Date.parse(leave.start);
                    const leaveEnd = Date.parse(leave.end);

                    // æª¢æŸ¥æ—¥æœŸé‡ç–Šï¼šå¦‚æœè«‹æ±‚é–‹å§‹æ—¥ <= å‡æœŸçµæŸæ—¥ ä¸” è«‹æ±‚çµæŸæ—¥ >= å‡æœŸé–‹å§‹æ—¥ï¼Œå‰‡ç™¼ç”Ÿè¡çª
                    if (reqStart <= leaveEnd && reqEnd >= leaveStart) {
                        return false; // ä¸å¯ç”¨
                    }
                }
            }
            return true; // å¯ç”¨
        }

        /**
         * å°‹æ‰¾ä¸¦è¿”å›æ‰€æœ‰å¯ç”¨çš„ä»£ç†äººåå–® (æŒ‰å„ªå…ˆç´šæ’åº)ã€‚
         * @returns {object} { header: string, candidates: Array<object> | null, error: string | null }
         */
        function getAvailableCandidates(employeeIdToFind, data, startDate, endDate, activeLeaves) {
            const leavingEmployee = data.find(emp => emp.id === employeeIdToFind);
            const header = `${leavingEmployee.name} (${leavingEmployee.id}) è«‹å‡ (${startDate} è‡³ ${endDate})`;
            const candidates = [];

            // --- æ­¥é©Ÿ 1 & 2: è™•ç†è¨±æ˜ç¥¥/å‘‚ä¿¡å¿ çš„ç‰¹æ®Šä»£ç†è¦å‰‡ (å½¼æ­¤äº’ç‚ºæŒ‡å®šä»£ç†) ---
            if (employeeIdToFind === SPECIAL_AGENT_A_ID) { // è¨±æ˜ç¥¥è«‹å‡
                if (isAvailable(SPECIAL_AGENT_B_ID, startDate, endDate, activeLeaves)) {
                    const substitute = data.find(emp => emp.id === SPECIAL_AGENT_B_ID);
                    substitute.type = 'æŒ‡å®šä»£ç†äºº';
                    candidates.push(substitute);
                    return { header, candidates }; // å¦‚æœæ‰¾åˆ°æŒ‡å®šä»£ç†ï¼Œå‰‡ç›´æ¥è¿”å›ï¼Œä¸è€ƒæ…®å…¶ä»–äºº
                } else {
                    return { header, candidates: null, error: "éŒ¯èª¤ï¼šè¨±æ˜ç¥¥çš„æŒ‡å®šä»£ç†äººå‘‚ä¿¡å¿ åœ¨è©²æ—¥æœŸç¯„åœå…§æ­£åœ¨ä¼‘å‡ã€‚" };
                }
            } else if (employeeIdToFind === SPECIAL_AGENT_B_ID) { // å‘‚ä¿¡å¿ è«‹å‡
                if (isAvailable(SPECIAL_AGENT_A_ID, startDate, endDate, activeLeaves)) {
                    const substitute = data.find(emp => emp.id === SPECIAL_AGENT_A_ID);
                    substitute.type = 'æŒ‡å®šä»£ç†äºº';
                    candidates.push(substitute);
                    return { header, candidates }; // å¦‚æœæ‰¾åˆ°æŒ‡å®šä»£ç†ï¼Œå‰‡ç›´æ¥è¿”å›ï¼Œä¸è€ƒæ…®å…¶ä»–äºº
                } else {
                    return { header, candidates: null, error: "éŒ¯èª¤ï¼šå‘‚ä¿¡å¿ çš„æŒ‡å®šä»£ç†äººè¨±æ˜ç¥¥åœ¨è©²æ—¥æœŸç¯„åœå…§æ­£åœ¨ä¼‘å‡ã€‚" };
                }
            }

            // --- æ­¥é©Ÿ 3: è™•ç†å…¶ä»–å“¡å·¥çš„ä»£ç†è¦å‰‡ (ç‰¹æ¬Šå„ªå…ˆ) ---

            // 3.1 å„ªå…ˆæª¢æŸ¥è¨±æ˜ç¥¥æˆ–å‘‚ä¿¡å¿ æ˜¯å¦å¯ä½œç‚ºä»£ç†äºº (ç‰¹æ¬Šä»£ç†)
            for (const specialId of [SPECIAL_AGENT_A_ID, SPECIAL_AGENT_B_ID]) {
                if (isAvailable(specialId, startDate, endDate, activeLeaves)) {
                    const specialAgent = data.find(emp => emp.id === specialId);
                    // ä½¿ç”¨æ“´å±•é‹ç®—ç¬¦è¤‡è£½ï¼Œé¿å…ä¿®æ”¹åŸå§‹æ•¸æ“š
                    candidates.push({...specialAgent, type: 'ç‰¹æ¬Šä»£ç†äºº (é«˜éš)'}); 
                }
            }
            
            // 3.2 å°‹æ‰¾æ‰€æœ‰å…¶ä»–å¯ç”¨çš„æ™®é€šå“¡å·¥ (ä¸€èˆ¬å€™è£œ)
            data.forEach(emp => {
                const isSelf = emp.id === employeeIdToFind;
                const isSpecialAgent = emp.id === SPECIAL_AGENT_A_ID || emp.id === SPECIAL_AGENT_B_ID;
                
                // å¦‚æœä¸æ˜¯è«‹å‡äººæœ¬äººã€ä¹Ÿä¸æ˜¯ç‰¹æ¬Šä»£ç†äººï¼Œä¸”ç•¶æ—¥å¯ç”¨ï¼Œå‰‡åŠ å…¥æ¸…å–®
                if (!isSelf && !isSpecialAgent && isAvailable(emp.id, startDate, endDate, activeLeaves)) {
                    // å†æ¬¡æª¢æŸ¥ï¼Œé¿å…èˆ‡ç‰¹æ¬Šä»£ç†äººé‡è¤‡
                    if (!candidates.some(c => c.id === emp.id)) { 
                        candidates.push({...emp, type: 'ä¸€èˆ¬å€™è£œå“¡å·¥'});
                    }
                }
            });

            if (candidates.length === 0) {
                 return { header, candidates: null, error: "æ‰¾ä¸åˆ°ä»»ä½•å¯ç”¨çš„ä»£ç†äºº (æ‰€æœ‰å“¡å·¥åœ¨è©²æ—¥æœŸéƒ½å·²ä¼‘å‡)ã€‚" };
            }

            return { header, candidates };
        }

        /**
         * è™•ç†å–æ¶ˆè«‹å‡çš„é‚è¼¯ï¼šå¾ activeLeaves åˆ—è¡¨ä¸­ç§»é™¤æŒ‡å®šè¨˜éŒ„ä¸¦é‡æ–°æ¸²æŸ“åˆ—è¡¨ã€‚
         */
        function cancelLeave(leaveKey) {
            // FIX: ä½¿ç”¨ '|' ä½œç‚ºåˆ†éš”ç¬¦ï¼Œé¿å…æ—¥æœŸå­—ä¸²ä¸­çš„ '-' é€ æˆéŒ¯èª¤è§£æ
            const [employeeId, startDate] = leaveKey.split('|');

            // Find the index of the leave record in the activeLeaves array
            const indexToRemove = activeLeaves.findIndex(leave => 
                leave.id === employeeId && leave.start === startDate
            );

            if (indexToRemove > -1) {
                // Remove the leave record from the array
                activeLeaves.splice(indexToRemove, 1);
                
                // Re-render the list to update the UI
                displayActiveLeaves(); 

                // Show success message
                renderResult('success', 'è«‹å‡å·²å–æ¶ˆ', `å“¡å·¥ ${getEmployeeNameById(employeeId)} (${employeeId}) å¾ ${startDate} é–‹å§‹çš„è«‹å‡è¨˜éŒ„å·²æˆåŠŸå–æ¶ˆã€‚`);
            } else {
                renderResult('error', 'å–æ¶ˆå¤±æ•—', 'æ‰¾ä¸åˆ°å°æ‡‰çš„è«‹å‡è¨˜éŒ„ã€‚');
            }
        }


        // --- UI è™•ç†é‚è¼¯ (UI Logic) ---
        const employeeSelect = document.getElementById('employeeId');
        const leaveSelect = document.getElementById('leaveType');
        const startDateInput = document.getElementById('startDate');
        const endDateInput = document.getElementById('endDate');
        const searchButton = document.getElementById('searchButton');
        const confirmButton = document.getElementById('confirmButton');
        const resultBox = document.getElementById('result-box');
        const selectionArea = document.getElementById('selection-area');
        const substituteSelect = document.getElementById('substituteSelect');
        const activeLeavesList = document.getElementById('active-leaves-list'); 

        
        // ç·©å­˜æŸ¥è©¢çµæœçš„è³‡è¨Š
        let currentQueryInfo = {};

        // è¼”åŠ©å‡½æ•¸ï¼šæ ¹æ“š ID æŸ¥æ‰¾å“¡å·¥å§“å
        function getEmployeeNameById(id) {
            const employee = employeeData.find(emp => emp.id === id);
            return employee ? employee.name : id;
        }

        // å¡«å……å“¡å·¥å’Œå‡åˆ¥ä¸‹æ‹‰é¸å–®
        function populateSelectors() {
            employeeData.forEach(emp => {
                const option = document.createElement('option');
                option.value = emp.id;
                option.textContent = `${emp.name} (${emp.id})`; 
                employeeSelect.appendChild(option);
            });

            LEAVE_TYPES.forEach(type => {
                const option = document.createElement('option');
                option.value = type;
                option.textContent = type;
                leaveSelect.appendChild(option);
            });
        }

        // é¡¯ç¤ºç•¶å‰ä¼‘å‡äººå“¡èˆ‡ä»£ç†äººåˆ—è¡¨ (å·²æ–°å¢æ—¥æœŸéæ¿¾åŠŸèƒ½)
        function displayActiveLeaves() {
            // ç²å–ä»Šå¤©çš„æ—¥æœŸï¼Œä¸¦å°‡æ™‚é–“è¨­ç½®ç‚ºåˆå¤œ (00:00:00)ï¼Œç”¨æ–¼æ—¥æœŸçš„æº–ç¢ºæ¯”è¼ƒ
            const today = new Date();
            today.setHours(0, 0, 0, 0); // ç¢ºä¿åªæ¯”è¼ƒæ—¥æœŸéƒ¨åˆ†

            // éæ¿¾æ‰çµæŸæ—¥æœŸæ—©æ–¼ä»Šå¤©çš„è«‹å‡è¨˜éŒ„
            const filteredLeaves = activeLeaves.filter(leave => {
                // å°‡è«‹å‡çµæŸæ—¥æœŸå­—ä¸²è½‰æ›ç‚º Date ç‰©ä»¶ã€‚
                // ç‚ºäº†é¿å…æ™‚å€å•é¡Œï¼Œæˆ‘å€‘ä½¿ç”¨ YYYY, MM-1, DD çš„æ–¹å¼å‰µå»º Date ç‰©ä»¶ï¼Œç¢ºä¿åœ¨æœ¬åœ°æ™‚å€çš„åˆå¤œé–‹å§‹ã€‚
                const [year, month, day] = leave.end.split('-').map(Number);
                // æœˆä»½æ˜¯ 0-basedï¼Œæ‰€ä»¥è¦æ¸› 1
                const leaveEndDate = new Date(year, month - 1, day); 

                // å¦‚æœè«‹å‡çµæŸæ—¥ï¼ˆleaveEndDateï¼‰ç­‰æ–¼æˆ–æ™šæ–¼ä»Šå¤©ï¼ˆtodayï¼‰ï¼Œå‰‡ä¿ç•™
                return leaveEndDate.getTime() >= today.getTime();
            });


            if (filteredLeaves.length === 0) {
                activeLeavesList.innerHTML = '<li class="text-gray-500 p-2 border border-gray-200 rounded-lg">ç›®å‰æ²’æœ‰å“¡å·¥åœ¨ä¼‘å‡ä¸­ã€‚</li>';
                return;
            }

            const listItems = filteredLeaves.map(leave => { // ä½¿ç”¨éæ¿¾å¾Œçš„åˆ—è¡¨
                const name = getEmployeeNameById(leave.id);
                const proxyName = getEmployeeNameById(leave.proxyId); 

                // FIX: å‰µå»ºå”¯ä¸€çš„ Key (å“¡å·¥ID|é–‹å§‹æ—¥æœŸ)ï¼Œä½¿ç”¨ '|' ä½œç‚ºåˆ†éš”ç¬¦
                const leaveKey = `${leave.id}|${leave.start}`;

                // æ ¼å¼åŒ–è¼¸å‡ºï¼šé¡¯ç¤ºè«‹å‡äºº (ä¸å¸¶ID)ã€ä¼‘å‡å€é–“å’Œè·å‹™ä»£ç†äºº (ä¸å¸¶ID)
                return `<li class="p-2 bg-gray-50 rounded-lg border border-gray-200 shadow-sm flex justify-between items-center">
                            <div>
                                <div class="font-semibold text-indigo-700">${name}</div>
                                <div class="mt-0.5 ml-2 text-xs text-gray-600">
                                    å‡æœŸï¼š<span class="text-red-600 font-medium">${leave.start}</span> è‡³ <span class="text-red-600 font-medium">${leave.end}</span>
                                </div>
                                <div class="mt-0.5 ml-2 text-xs text-gray-600">
                                    è·å‹™ä»£ç†äººï¼š<span class="text-green-600 font-medium">${proxyName}</span>
                                </div>
                            </div>
                            <!-- æ–°å¢å–æ¶ˆæŒ‰éˆ• -->
                            <button type="button" 
                                    class="cancel-leave-btn bg-red-500 hover:bg-red-600 text-white text-xs font-semibold py-1 px-2 rounded-lg transition duration-150"
                                    data-leave-key="${leaveKey}">
                                å–æ¶ˆè«‹å‡
                            </button>
                        </li>`;
            }).join('');

            activeLeavesList.innerHTML = listItems;
        }

        // æ¸²æŸ“çµæœåˆ°UI
        function renderResult(status, header, message) {
            let bgColor = 'bg-yellow-50';
            let borderColor = 'border-yellow-300';
            let textColor = 'text-gray-700';
            let icon = 'ğŸ”';

            if (status === 'success') {
                bgColor = 'bg-green-50';
                borderColor = 'border-green-300';
                textColor = 'text-green-800';
                icon = 'âœ…';
            } else if (status === 'fail' || status === 'error') {
                bgColor = 'bg-red-50';
                borderColor = 'border-red-300';
                textColor = 'text-red-800';
                icon = 'âŒ';
            } else if (status === 'pending') {
                bgColor = 'bg-blue-50';
                borderColor = 'border-blue-300';
                textColor = 'text-blue-800';
                icon = 'ğŸ“';
            }

            // ä½¿ç”¨æ­£å‰‡è¡¨é”å¼å°‡ **ç²—é«”** è½‰æ›ç‚º <b> æ¨™ç±¤
            let formattedMessage = message.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>');

            let html = `<div class="font-bold text-lg mb-2 ${textColor}">${icon} ${header || 'ç³»çµ±è¨Šæ¯'}</div>`;
            html += `<p class="text-base">${formattedMessage}</p>`;
            
            resultBox.className = `min-h-[100px] p-4 border rounded-lg ${bgColor} ${borderColor} ${textColor}`;
            resultBox.innerHTML = html;
        }

        // --- éšæ®µ 1: æŸ¥æ‰¾å€™é¸äºº ---
        searchButton.addEventListener('click', () => {
            const employeeId = employeeSelect.value;
            const leaveType = leaveSelect.value;
            const startDate = startDateInput.value;
            const endDate = endDateInput.value;

            selectionArea.classList.add('hidden'); // éš±è—é¸æ“‡å€

            if (!employeeId || !leaveType || !startDate || !endDate) {
                renderResult('error', 'è¼¸å…¥éŒ¯èª¤', 'è«‹å¡«å¯«æ‰€æœ‰æ¬„ä½ã€‚');
                return;
            }

            if (Date.parse(startDate) > Date.parse(endDate)) {
                renderResult('error', 'æ—¥æœŸç„¡æ•ˆ', 'é–‹å§‹æ—¥æœŸä¸èƒ½æ™šæ–¼çµæŸæ—¥æœŸã€‚');
                return;
            }

            // åŸ·è¡ŒæŸ¥æ‰¾æ‰€æœ‰å€™é¸äºº
            const result = getAvailableCandidates(employeeId, employeeData, startDate, endDate, activeLeaves);
            
            // ç”±æ–¼ç”¨æˆ¶è¦æ±‚è«‹å‡äºº ID ä¸é¡¯ç¤ºåœ¨åˆ—è¡¨ä¸­ï¼Œä½†æŸ¥è©¢çµæœçš„ header ä»éœ€ ID é€²è¡Œå€åˆ†ï¼Œæ•…æ­¤è™•ä¿ç•™å®Œæ•´ headerã€‚
            // é€™æ¨£åœ¨é ‚éƒ¨çš„çµæœæç¤ºå€ä»ç„¶èƒ½çœ‹åˆ°è«‹å‡äººçš„å®Œæ•´è³‡è¨Šã€‚
            currentQueryInfo = { employeeId, leaveType, startDate, endDate, header: result.header };

            // è™•ç†æ‰¾ä¸åˆ°å€™é¸äººçš„éŒ¯èª¤
            if (result.error) {
                renderResult('fail', result.header, result.error);
                return;
            }

            // æ‰¾åˆ°å€™é¸äººï¼Œæº–å‚™æ¸²æŸ“é¸æ“‡å€
            
            // 1. æ¸…ç©ºèˆŠé¸é …ä¸¦é‡æ–°åŠ å…¥é è¨­é¸é …
            substituteSelect.innerHTML = '<option value="" disabled selected>è«‹é¸æ“‡ä¸€ä½ä»£ç†äºº...</option>';
            
            // 2. å¡«å……æ–°é¸é …
            result.candidates.forEach(candidate => {
                const option = document.createElement('option');
                option.value = candidate.id;
                option.textContent = `${candidate.name} (${candidate.id}) - ${candidate.type}`;
                substituteSelect.appendChild(option);
            });

            // 3. é¡¯ç¤ºé¸æ“‡å€ä¸¦æç¤ºç”¨æˆ¶
            selectionArea.classList.remove('hidden');
            renderResult('pending', result.header, `âœ… æˆåŠŸæ‰¾åˆ° ${result.candidates.length} ä½å¯ç”¨ä»£ç†äººã€‚è«‹å¾ä¸‹æ–¹çš„é¸å–®ä¸­é¸æ“‡ä¸€ä½ï¼Œç„¶å¾Œé»æ“Šç¢ºèªæŒ‰éˆ•ã€‚`);
        });

        // --- éšæ®µ 2: ç¢ºèªæœ€çµ‚é¸æ“‡ ---
        confirmButton.addEventListener('click', () => {
            const selectedAgentId = substituteSelect.value;

            if (!selectedAgentId) {
                renderResult('error', currentQueryInfo.header, 'è«‹å…ˆå¾ä¸‹æ‹‰å¼é¸å–®ä¸­é¸æ“‡ä¸€ä½ä»£ç†äººï¼');
                return;
            }

            const selectedAgent = employeeData.find(emp => emp.id === selectedAgentId);
            const originalEmployee = employeeData.find(emp => emp.id === currentQueryInfo.employeeId);
            
            // æª¢æŸ¥æ˜¯å¦ç‚ºç‰¹æ®Šè¦å‰‡æŒ‡å®š (è¨±æ˜ç¥¥/å‘‚ä¿¡å¿ äº’ç‚ºä»£ç†)
            const isSpecialAssignment = 
                (currentQueryInfo.employeeId === SPECIAL_AGENT_A_ID && selectedAgentId === SPECIAL_AGENT_B_ID) ||
                (currentQueryInfo.employeeId === SPECIAL_AGENT_B_ID && selectedAgentId === SPECIAL_AGENT_A_ID);
            
            let message = '';

            if (isSpecialAssignment) {
                 message = `**è·å‹™ä»£ç†äººç¢ºèªï¼š** ${selectedAgent.name} ï¼ˆID: ${selectedAgent.id}ï¼‰ **å·²æ ¹æ“šç‰¹æ®Šè¦å‰‡æŒ‡å®šã€‚**`;
            } else if (selectedAgentId === SPECIAL_AGENT_A_ID || selectedAgentId === SPECIAL_AGENT_B_ID) {
                 message = `**è·å‹™ä»£ç†äººç¢ºèªï¼š** ${selectedAgent.name} ï¼ˆID: ${selectedAgent.id}ï¼‰ **å·²æŒ‡å®šç‚ºç‰¹æ¬Šä»£ç†äººã€‚**`;
            } else {
                 message = `**è·å‹™ä»£ç†äººç¢ºèªï¼š** ${selectedAgent.name} ï¼ˆID: ${selectedAgent.id}ï¼‰ **å·²æŒ‡å®šç‚ºå€™è£œä»£ç†äººã€‚**`;
            }

            renderResult('success', 
                `${originalEmployee.name} (${originalEmployee.id}) è«‹ã€${currentQueryInfo.leaveType}ã€‘ç¢ºèªçµæœ`,
                message + `<br>è«‹å‡å€é–“ï¼š${currentQueryInfo.startDate} è‡³ ${currentQueryInfo.endDate}`
            );

            // --- å°‡ç¢ºèªçš„è«‹å‡è¨˜éŒ„æ·»åŠ åˆ° activeLeaves åˆ—è¡¨ä¸­ï¼Œä½¿å…¶å¯è¢«å–æ¶ˆ ---
            const newLeave = {
                id: currentQueryInfo.employeeId,
                start: currentQueryInfo.startDate,
                end: currentQueryInfo.endDate,
                proxyId: selectedAgentId,
            };

            // 1. æ·»åŠ åˆ°æ´»èºåˆ—è¡¨
            activeLeaves.push(newLeave);

            // 2. é‡æ–°æ¸²æŸ“åˆ—è¡¨ä»¥é¡¯ç¤ºæ–°è¨˜éŒ„å’Œå¯ç”¨çš„å–æ¶ˆæŒ‰éˆ•
            displayActiveLeaves(); 

            // æ¸…ç† UI
            selectionArea.classList.add('hidden');
        });

        // --- å–æ¶ˆè«‹å‡æŒ‰éˆ•çš„äº‹ä»¶å§”æ´¾ (Event Delegation) ---
        activeLeavesList.addEventListener('click', (event) => {
            // æª¢æŸ¥é»æ“Šçš„ç›®æ¨™æˆ–å…¶ç¥–å…ˆæ˜¯å¦æ˜¯å¸¶æœ‰ 'cancel-leave-btn' é¡åˆ¥çš„æŒ‰éˆ•
            const button = event.target.closest('.cancel-leave-btn');
            if (button) {
                const leaveKey = button.dataset.leaveKey;
                if (leaveKey) {
                    // å‘¼å«å–æ¶ˆè™•ç†å‡½æ•¸
                    cancelLeave(leaveKey);
                }
            }
        });

        // åˆå§‹åŒ–ï¼šåœ¨é é¢è¼‰å…¥æ™‚å¡«å……ä¸‹æ‹‰é¸å–®ä¸¦é¡¯ç¤ºä¼‘å‡åˆ—è¡¨
        populateSelectors();
        displayActiveLeaves(); 
    </script>
</body>
</html>